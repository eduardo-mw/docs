---
title: "Next.js"
---
<a target="_blank" href="https://www.npmjs.com/package/@middleware.io/agent-apm-nextjs">
    <span style={{
        background: "url(https://img.shields.io/npm/v/%40middleware.io%2Fagent-apm-nextjs) no-repeat",
        width: "125px",
        height: "20px",
        display: "inline-block",
    }}/>
</a>

| Traces | Metrics | App Logs | Custom Logs | Profiling |
| :----: | :-----: | :------: | :---------: | :-------: |
| ✅ | ✖️ | ✖️ | ✅ | ✅ |

This guide walks you through setting up Application Performance Monitoring (APM) on a Next.js application. These instructions can also be found on the Installation page in your Middleware Account. View demo code [here](https://github.com/middleware-labs/demo-apm/tree/master/nextjs).

## Prerequisites
* Middleware Host Agent (MW Agent), to install the MW Agent please see our [installation guide](https://docs.middleware.io/docs/agent-installation/overview).
* Next.js version 13.4+, you can check your Next.js version with the following command.
```bash Shell
npx next --version
```
* @opentelemetry/api package installed. If not installed run this command
```bash Shell
npm install @opentelemetry/api”>=1.3.0 <1.5.0”
```

## Step 1: Install Next.js APM Package
Run the following command in your terminal.
```bash Shell 
npm install @middleware.io/agent-apm-nextjs
```

## Step 2: Modify Config File
Add the following to your next.config.js file.
```javascript Next.js
const nextConfig = {
    // ...
    // Your existing config

     experimental: {
         instrumentationHook: true
     }

    // ...
    // Your existing config
}
module.exports = nextConfig
```

## Step 3: Container Variables
Applications running in a container require an additional environment variable. If your application is not running in a container, move to Step 5. 

For Docker containers, add the following environment variable to your application.
```bash Shell
MW_AGENT_SERVICE=<DOCKER_BRIDGE_GATEWAY_ADDRESS>
```
<Note> docker bridge gateway address is the IP address of the gateway between the Docker host and the bridge network, which is 172.17.0.1 by default. 
Refer more about Docker bridge networking [here](https://docs.docker.com/network/network-tutorial-standalone/) </Note>

```bash Shell
kubectl get service --all-namespaces | grep mw-service
```

Then add the following environment variable to your application deployment YAML file. 
```bash Shell
MW_AGENT_SERVICE=mw-service.mw-agent-ns.svc.cluster.local
```
## Step 4: Vercel Integration
Middleware offers a Vercel integration that streams traces from Vercel projects into Middleware where they can be viewed alongside logs and profiling information on the APM dashboard. If not using Vercel, skip this step.

Add the [Middleware integration](https://vercel.com/integrations/middleware/new) from the Vercel marketplace and follow the instructions to select the Vercel projects and log in to Middleware.

## Step 5: Create Instrumentation File
Create a custom instrumentation.ts (or .js) file in your project root directory or inside the src folder, if applicable. Add the appropriate code snippet from the following options. The access token is your account key, which can be found on the Installation page.

For projects deployed through Vercel (note Step 3 must be completed). 
```javascript Next.js
// @ts-ignore
import tracker from '@middleware.io/agent-apm-nextjs';

export function register() {
    tracker.track({
        projectName: "<PROJECT-NAME>",
        serviceName: "<SERVICE-NAME>",
        accessToken: "<xxxxxxxxxx>",
        target: "vercel"
    });
}
```
For machines with the Middleware Agent (MW Agent) installed.
```javascript Next.js
// @ts-ignore
import tracker from '@middleware.io/agent-apm-nextjs';

export function register() {
    tracker.track({
        projectName: "<PROJECT-NAME>",
        serviceName: "<SERVICE-NAME>",
        accessToken: "<xxxxxxxxxx>"
    });
}
```
For machines that do NOT have the Middleware Agent (MW Agent) installed.
```javascript Next.js
// @ts-ignore
import tracker from '@middleware.io/agent-apm-nextjs';

export function register() {
    tracker.track({
        projectName: "<PROJECT-NAME>",
        serviceName: "<SERVICE-NAME>",
        accessToken: "<ACCESS-TOKEN>",
        target: "https://{ACCOUNT-UID}.middleware.io"
    });
}
```

## Step 6: Enable Logging
To ingest custom logs, utilize the following functions based on desired log severity levels.
```javascript Next.js
// @ts-ignore
import tracker from '@middleware.io/agent-apm-nextjs';

export default async function handler(req, res) {
    // ...
    // Your existing code

    tracker.info("Info Sample");
    tracker.warn("Warn Sample", {
        "tester": "Alex",
    });
    tracker.debug("Debug Sample");
    tracker.error("Error Sample");

    // ...
    // Your existing code
}
```

<Note> Need assistance or want to learn more about Middleware? Contact us at support[at]middleware.io. </Note>
